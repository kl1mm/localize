# Localize
Simple package to localize **strings** via static source code generation from json files.

Implemented via [C# source generators](https://docs.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/source-generators-overview)

[![CI\CD](https://github.com/kl1mm/localize/actions/workflows/dotnet.yml/badge.svg?branch=main)](https://github.com/kl1mm/localize/actions/workflows/dotnet.yml)

## Usage

[**See example project**](https://github.com/kl1mm/localize/tree/develop/example/kli.Localize.Example)

### Install the nuget package
Add the following [Nuget package reference](https://www.nuget.org/packages/kli.Localize/) to the project file in the project you want to localize:<br>

`<PackageReference Include="kli.Localize" Version="<version>" />`

### Create *.json files for your localized texts.
```json
{
    "SampleText": "FooBar",
    "Other": "Text42"
}
```
Just give your default language a name **without** specifying the culture (e.g. `Locale.json`). All other languages follow the pattern `<Filename>_<CultureInfo.Name>.json` (e.g. `Locale_en-US.json` for American English or `Locale_en.json` for English)

![locale_files image][locale_files]

### Add json files to csproj
Add an `ItemGroup` to your project file (csproj). Foreach json file add an `AdditionFiles`-Element with the `Include` attribute set to the path of the file.

```xml
<Project Sdk="Microsoft.NET.Sdk">

    <ItemGroup>
        <PackageReference Include="kli.Localize" Version="0.6.*" />

        <AdditionalFiles Include="TestLocalizations\Locale.json" />
    </ItemGroup>

</Project>
```

### Use it
Now, if everythings works fine you should be able to locate the generated source code in you Solution-Explorer under Dependencies/Analysers.<br>
Of course you can also view and even debug the generated source code.<br>

<details>
  <summary>Generated code example</summary>

```csharp
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by kli.Localize.Generator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
namespace kli.Localize.Example.Localizations
{
    using System;
    using System.Globalization;
    using System.Collections.Generic;
    using Translations = System.Collections.Generic.Dictionary<string, string>;

    public sealed class Locale
    {
        private static readonly LocalizationProvider provider = new LocalizationProvider();
        public static IDictionary<string, string> GetAll(CultureInfo cultureInfo = null) => provider.GetValues(cultureInfo ?? CultureInfo.CurrentUICulture);
        public static string GetString(string key, CultureInfo cultureInfo = null) => provider.GetValue(key, cultureInfo ?? CultureInfo.CurrentUICulture);
        ///<summary>Similar to: "Hallo Welt (German)"</summary>
        public static string MyText => provider.GetValue(nameof(MyText), CultureInfo.CurrentUICulture);
        private class LocalizationProvider
        {
            delegate bool SelectorFunc<T>(Translations translations, out T arg);
            internal string GetValue(string key, CultureInfo cultureInfo)
            {
                bool ValueSelector(Translations translations, out string value)
                {
                    if (translations.TryGetValue(key, out value))
                        return true;
                    value = key;
                    return false;
                }

                return TraverseCultures<string>(cultureInfo, ValueSelector);
            }

            internal IDictionary<string, string> GetValues(CultureInfo cultureInfo)
            {
                bool ValueSelector(Translations translations, out Translations value)
                {
                    value = translations;
                    return true;
                }

                return TraverseCultures<Translations>(cultureInfo, ValueSelector);
            }

            private T TraverseCultures<T>(CultureInfo cultureInfo, SelectorFunc<T> selectorFunc)
            {
                while (cultureInfo != CultureInfo.InvariantCulture)
                {
                    if (resources.TryGetValue(cultureInfo, out Translations translations))
                    {
                        if (selectorFunc(translations, out T result))
                            return result;
                    }

                    cultureInfo = cultureInfo.Parent;
                }

                selectorFunc(resources[CultureInfo.InvariantCulture], out T retVal);
                return retVal;
            }

            private static readonly Translations invariant = new()
            {{"MyText", "Hallo Welt (German)"}, };
            private static readonly Translations en = new()
            {{"MyText", "Hello World (English)"}, };
            private static readonly Dictionary<CultureInfo, Translations> resources = new()
            {{CultureInfo.InvariantCulture, invariant}, {new CultureInfo("en"), en}, };
        }
    }
}
```
</details>

<br>

![generated_1 image][generated_1]
<br>

Import the namespace where you put your *.json files an use the generated code to access your localizations.<br><br>
![useit image][useit]


## Why is no code generated?
Directly after including the package sometimes the tooling (Visual Studio) gets stuck. If you encounter any problems with source generation try to restart Visual Studio and/or check the build log for warnings/errors.

[locale_files]: docs/locale_files.png
[generated_1]: docs/generated_1.png
[useit]: docs/useit.png